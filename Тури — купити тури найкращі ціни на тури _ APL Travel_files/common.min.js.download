var Tooltips=[],Texts=1;function dialogCloseTimer(t,e,i){e=e||10,i=i||"Закрыть",t.dialog({buttons:[{text:i,click:function(){clearInterval(window.closeInterval),$(this).dialog("close")}}]}),window.closeInterval=setInterval(function(){--e<0?(t.dialog("close"),clearInterval(window.closeInterval)):t.dialog({buttons:[{text:i+" ("+e+" cекунд)",click:function(){clearInterval(window.closeInterval),$(this).dialog("close")}}]})},1e3)}function showTooltip(){if(0<Tooltips.length){var t=Tooltips.shift(),e=(t[0],$(t[1]));$("body").after(e);var i=e.height();i=0==i?200:100+i,$("#page_container .mytooltip").animate({bottom:"+="+i+"px"},500),e.appendTo("#maintext"),e.fadeIn("slow"),setTimeout(function(){e.fadeOut("slow")},1e4),setTimeout(showTooltip,3e3)}}function addTooltip(t){var e=Tooltips.length+1;Tooltips.push([e,'<div id="tooltip'+e+'" class="ui-tooltip ui-widget ui-corner-all mytooltip">'+t+"</div>"])}window.fbAsyncInit=function(){FB.init({appId:FBAPPID,xfbml:!0,version:"v2.9"})},function(t,e,i){var s,o=t.getElementsByTagName(e)[0];t.getElementById(i)||((s=t.createElement(e)).id=i,s.src="//connect.facebook.net/ru_RU/sdk.js",o.parentNode.insertBefore(s,o))}(document,"script","facebook-jssdk"),$(document).ready(function(){if(setTimeout(showTooltip,3e3),$("#selectMainCountry").change(function(){window.location=$(this).val()}),$(".show-tooltip").tooltip({position:{my:"center bottom-15",at:"center top",using:function(t,e){$(this).css(t),$("<div>").addClass("arrow").addClass(e.vertical).addClass(e.horizontal).appendTo(this)}},content:function(){return $(this).prop("title")}}),$("#makeRequest")){var t=setTimeout(function(){$("#makeRequest").tooltip({position:{my:"center bottom-15",at:"center top",using:function(t,e){$(this).css(t),$("<div>").addClass("arrow").addClass(e.vertical).addClass(e.horizontal).appendTo(this)}},open:function(t,e){setTimeout(function(){$("#makeRequest").tooltip("close")},1e4)},content:"Если сомневатесь, отправьте заявку на подбор тура и профессиональный менеджер по туризму поможет Вам подобрать оптимальный вариант"}).tooltip("open")},6e4);$("#makeRequest").click(function(){clearTimeout(t)})}function o(t,e){this.button=$(t),this.box=$(e),this.isOpen=!1,this.timer=null,this.button.click($.proxy(this.clickHandler,this)).hover($.proxy(this.openHandler,this),$.proxy(this.closeHandler,this)),this.box.hover($.proxy(this.openHandler,this),$.proxy(this.closeHandler,this))}$(document).on("click change","#addFavourites .listsItem",function(t){addLoaderSmall($(this)),$("#addFavourites input").attr("disabled","disabled"),toggleFavourites($(this))}),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://apis.google.com/js/client:plusone.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}(),$("#newFavouritesListSave").click(function(){CSRF=$("#YII_CSRF_TOKEN").val(),name=$("#newFavouritesListName").val(),""==name?$("#newFavouritesListError").html("Введите название нового списка"):($("#newFavouritesListError").html(""),$.ajax({url:"/favourites/addList",type:"POST",data:{name:name,YII_CSRF_TOKEN:CSRF}}).done(function(e){try{data=$.parseJSON(e),data.id&&$("#newFavouritesList").before(data.string)}catch(t){alert(e)}}))}),$(".AddFavourites,.AddedFavourites").click(function(){isAuth?$("#addFavourites").dialog({title:"Добавить в Избранное",width:700,height:350,modal:!0,draggable:!1,resizable:!1,buttons:{"Добавить список":function(){$("#newFavouritesList").toggle()}}}):$("#addFavourites").dialog({title:"Добавить в Избранное",width:700,height:350,modal:!0,draggable:!1,resizable:!1,buttons:{}})}),o.prototype.openHandler=function(){return this.isOpen?clearTimeout(this.timer):this.timer=setTimeout($.proxy(this.open,this),400)},o.prototype.closeHandler=function(){return this.isOpen?this.timer=setTimeout($.proxy(this.close,this),400):clearTimeout(this.timer)},o.prototype.clickHandler=function(t){return clearTimeout(this.timer),this.open()},o.prototype.open=function(){this.isOpen=!0,this.box.show(),$(document).on("keydown.mainMenu",$.proxy(function(t){27==t.which&&(this.close(),t.stopPropagation())},this)).on("click.mainMenu",$.proxy(function(t){$(t.target).closest(this.box).length||$(t.target).closest(this.button).length||(this.close(),t.stopPropagation())},this))},o.prototype.close=function(){this.isOpen=!1,this.box.hide(),$(document).off("click.mainMenu keydown.mainMenu")},$("#design_orderpath_container > ul > li").each(function(t,e){var i=(e=$(e)).children(".headerMenu_button"),s=e.children(".onsiteHeaderMenu_box");0<s.length&&0<i.length&&e.data("menu",new o(i,s))}),$("#header_projects a.header_tabs__tours").on("click",function(t){return t.preventDefault(),!1});new o($("#header_projects a.header_tabs__tours"),$(".headerMenu_box.countryList:eq(0)"));new o($("a.header_tabs__airtour"),$(".onsiteHeaderMenu_box.countryList"));function i(t){this.el=$(t),this.item_type=this.el.data("item-type"),this.item_id=this.el.data("item-id"),this.finded={},this.el.on("click",$.proxy(this.formLists,this))}setTimeout(function(){$("#design_orderpath_container > ul > li.third").addClass("blink"),setTimeout(function(){$("#design_orderpath_container > ul > li.third").removeClass("blink"),setTimeout(function(){$("#design_orderpath_container > ul > li.third").addClass("blink"),setTimeout(function(){$("#design_orderpath_container > ul > li.third").removeClass("blink")},250)},250)},250)},3e3),$("#enableMobile").click(function(t){$.cookie("mobile_disabled",null,{path:"/"}),"?mobile_disabled=true"===window.location.search?window.location.assign(window.location.protocol+"//"+window.location.hostname):window.location.reload(!0),t.preventDefault()}),i.prototype.createForm=function(t,e,i){_gaq.push(["_trackEvent","Favourite","openAddForm"]),e=e||500,i=i||"favouriteItemForm";var s=$(document.createElement("div"));return s.loading("start"),s.dialog({title:t,draggable:!1,resizable:!1,modal:!0,width:e,dialogClass:i,closeText:"Закрыть",close:function(t,e){$(this).dialog("destroy")}}),s},i.prototype.formLists=function(){var e=this.createForm("Ваши фавориты");return $.ajax(this.el.attr("href"),{method:"GET",dataType:"json",error:function(t){e.html('<div class="alert alert-danger">Не удалось получить Вашм списки фаворитов</div>'),console.log(t.responseText)},success:$.proxy(this.renderFormLists,this,e)}),!1},i.prototype.renderFormLists=function(t,e){var i="";if(e.target&&e.lists){if(e.target.photo&&(i+='<div class="favouriteItemPhoto"><img src="'+e.target.photo+'" /></div>'),i+='<div class="favouriteItemInfo"><div class="name"><h3>'+e.target.name+"</h3>"+(e.target.start_count?'<div class="stars" style="width: '+14*e.target.start_count+'px"></div><div class="clr"></div>':"")+'</div><div class="favouriteItemLists"><p>Выберите один или несколько <a href="/favourite">списков фаворитов</a></p><div id="favouriteItemResponse"></div><ul id="favouriteItemListsContainer">',e.lists.length)for(var s in e.lists){var o=e.lists[s];o.finded&&(this.finded[o.id]=!0),o.id=o.id||"new_"+Math.ceil(1e5*Math.random()),i+='<li id="favouriteList_'+o.id+'"><div class="favouriteItemListsActions">'+(o.shareLink?'<a class="shareButton" title="Поделиться" href="'+o.shareLink+'">Друзьям</a> ':"")+(o.queryLink?'<a class="queryButton" href="'+o.queryLink+'" data-target="места из списка '+o.name+'">Менеджеру</a>':"")+'</div><label><input type="checkbox" class="favouriteListCheckbox" value="'+o.id+'"'+(o.finded?' checked="checked"':"")+'><span id="list_name_'+o.id+'">'+o.name+'</span> <span class="countItems">('+o.items+")</span></label></li>"}i+='<li><div class="favouriteItemListsActions"><span class="activeButton activeButton-white" id="newList_button">Добавить и выбрать</span></div><input type="text" id="newList_name" value="Новый список"></li>',i+="</ul></div>",i+='</div><div class="clr"></div>'}else i='<div class="alert alert-danger">Ошибка сервера, получен некорректный ответ. Мы уже исправляем эту проблему.</div>';t.html(i),$('#favouriteItemListsContainer a[href*="/order/query"]').map(function(t,e){requestFormInstances[requestFormInstances.length]=new RequestForm(e,"query")}),this.responseContainer=$("#favouriteItemResponse"),$("#favouriteItemListsContainer").on("change",".favouriteListCheckbox",$.proxy(this.changeStatus,this)),$("#newList_button").on("click",$.proxy(this.createList,this))},i.prototype.changeStatus=function(t){var e=$(t.target);e.attr("disabled","disabled"),e.is(":checked")?this.appendToList(e.val()):this.removeFromList(e.val())},i.prototype.createList=function(){this.responseContainer.loading("start"),_gaq.push(["_trackEvent","Favourite","createList"]),$.ajax("/favourite/addToList",{method:"GET",dataType:"json",data:{type:this.item_type,id:this.item_id,list_id:"new",name:$("#newList_name").val()},error:$.proxy(function(t){this.responseContainer.html('<div class="alert alert-danger">Не удалось создать новый список</div>')},this),success:$.proxy(this.renderList,this)})},i.prototype.appendToList=function(t){this.responseContainer.loading("start"),_gaq.push(["_trackEvent","Favourite","appendToList"]),$.ajax("/favourite/addToList",{method:"GET",dataType:"json",data:{type:this.item_type,id:this.item_id,list_id:t,name:$("#list_name_"+t).text()},error:$.proxy(function(t){this.responseContainer.html('<div class="alert alert-danger">Не удалось добавить объект в список</div>')},this),success:$.proxy(this.renderList,this,t)})},i.prototype.removeFromList=function(t){this.responseContainer.loading("start"),_gaq.push(["_trackEvent","Favourite","removeFromList"]),$.ajax("/favourite/removeFromList",{method:"GET",dataType:"json",data:{type:this.item_type,id:this.item_id,list_id:t},error:$.proxy(function(t,e){this.renderList(t,{message:{type:"danger",text:"Не удалось убрать объект из списка"},list:{finded:!0}})},this,t),success:$.proxy(this.renderList,this,t)})},i.prototype.renderList=function(t,e){if("string"==typeof e&&(t=(e=t).original_list_id),e.message&&e.message.type&&e.message.text&&this.responseContainer.html('<div class="alert alert-'+e.message.type+'">'+e.message.text+"</div>"),e.list){var i=$("#favouriteList_"+t).get(0)||$("#favouriteList_"+e.original_list_id).get(0);if(i){var s=(i=$(i)).find(".favouriteListCheckbox");setTimeout(function(){s.removeAttr("disabled")},2e3),"undefined"!=e.list.finded&&(s[0].checked=e.list.finded,e.list.finded?this.finded[t]=!0:this.finded[t]=!1),e.list.id&&s.val(e.list.id),e.list.items&&i.find(".countItems").html("("+e.list.items+")")}else e.list||this.responseContainer.html('<div class="alert alert-danger">Неверный ответ сервера</div>'),$("#favouriteItemListsContainer li").last().before('<li id="favouriteList_'+e.list.id+'"><div class="favouriteItemListsActions">'+(e.list.shareLink?'<a class="shareButton" title="Поделиться" href="'+e.list.shareLink+'">Друзьям</a> ':"")+(e.list.queryLink?'<a class="queryButton" href="'+e.list.queryLink+'">Менеджеру</a>':"")+'</div><label><input type="checkbox" class="favouriteListCheckbox" value="'+e.list.id+'"'+(e.list.finded?' checked="checked"':"")+'><span id="list_name_'+e.list.id+'">'+e.list.name+'</span> <span class="countItems">('+e.list.items+")</span></label></li>"),$("#favouriteList_"+e.list.id+' a[href*="/order/query"]').map(function(t,e){requestFormInstances[requestFormInstances.length]=new RequestForm(e,"query")})}var o=!1;for(var a in this.finded)if(1==this.finded[a]){o=!0;break}o?this.el.removeClass("notExistsItem").addClass("existsItem").text("В избранном"):this.el.removeClass("existsItem").addClass("notExistsItem").text("В избранное")},$(".favouriteItem").each(function(t,e){new i(e)}),$("html").on("click",'a[href*="/favourite/list?secret="]',function(){var i=$(document.createElement("div"));return i.loading("start"),_gaq.push(["_trackEvent","Favourite","openShareForm"]),i.dialog({title:"Поделиться списком фаворитов",draggable:!1,resizable:!1,modal:!0,width:400,closeText:"Закрыть",close:function(t,e){$(this).dialog("destroy")}}),$.ajax($(this).attr("href"),{method:"get",dataType:"html",success:function(t){i.html(t),$("#favouriteShareForm").on("submit",function(){var e=$(this),t=e.serialize();e.loading("start","Идет отправка письма..."),_gaq.push(["_trackEvent","Favourite","sendFriendEmail"]),$.ajax(e.attr("action"),{method:e.attr("method"),data:t,success:function(t){e.html(t),dialogCloseTimer(i,10)},error:function(t){e.html('<div class="alert alert-danger">'+t.responseText+"</div>")}})})},error:function(t){i.html('<div class="alert alert-danger">'+t.responseText+"</div>")}}),!1})});
